<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title></title>

        <script type="text/javascript" src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
        <script src="simplify.js"></script>
        <script src="jquery-3.3.1.min.js"></script>

        <style media="screen">
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        canvas {
            /* border: 1px solid #aaa; */
            position: absolute;
            z-index: 99999;
            top: 0;
            left: 0;
        }
        </style>
    </head>
    <body>
        <canvas id="canv"></canvas>
        <div id="map"></div>
    </body>

    <script type="text/javascript">
	    var pointsJSON = '{"58":"55.839708495952,37.245218371658","54":"55.602112447466,37.346789251395","595":"55.722662866467,37.767666977524","606":"55.73130710949,37.763875813492","61":"56.349700566478,37.325158799056","65":"55.912222538514,37.19518245697","1293":"55.538740344663,37.368588249639","52":"55.589149225188,37.749809070022","1259":"55.823816,37.868196","1260":"55.831487,37.835467","1254":"55.957544,37.863539","1238":"55.49564,37.859003","1264":"55.915486,36.846654","109":"55.79039112346,36.77305951059","259":"55.735552996107,36.835684777771","212":"55.713439659932,36.827838890213","571":"55.911586196973,37.193503817444","160":"55.875492295942,37.134063641525","214":"55.947729196725,36.587670783046","266":"55.908629360293,36.820467203359","520":"55.840419186781,37.005965132541","546":"55.848925400698,36.923295046768","103":"55.929939,37.95683","288":"55.941225483634,37.843597043705","56":"55.941888308268,37.834974275463","627":"55.910673912382,37.887963593254","760":"55.629592687226,37.87078914418","129":"55.355351976764,37.53695196526","582":"55.463297940834,37.808344636246","573":"55.560082959429,37.694405765282","158":"55.553233,37.619088","149":"55.50286422675,37.666356487102","504":"55.463627785501,37.633762607993","113":"55.596336332442,37.819762283141","186":"55.607154262563,37.802685750655","572":"55.596805873371,37.801421917322","948":"55.599866304673,37.800306548106","1231":"55.591258,37.781652","170":"55.590544176353,37.767684670463","1253":"55.657057,38.071867","961":"55.905675457463,37.561366416505","960":"55.946625641287,37.537118487951","276":"55.633542564801,37.425145022808","1245":"55.646283,37.947804","1241":"55.575624,38.234839","792":"55.505217651819,37.73742775534","275":"55.905617217092,37.565256901668","66":"55.942045591524,37.325416957672","60":"56.007913839382,37.127928998581","277":"55.779406110438,37.318164958919","55":"55.537987085998,37.516051356964","53":"55.504033,37.330286","289":"55.804450229486,38.039432608031","532":"55.760340183933,36.854124246002","228":"55.518061430832,37.325275773895","592":"55.922047495901,37.470037169311","206":"55.68428034195,37.767766686508","759":"55.636774581993,37.97488614418","639":"55.496199038798,37.78424485247","638":"55.385901013132,37.608036608975","531":"55.55376523245,37.623854296295","578":"55.790780551661,38.12766087953","579":"55.98995695917,37.80511463887","125":"55.535142975209,36.987743273819","140":"55.882544976634,38.301343280457","611":"55.931957050026,37.286063921951","613":"55.903909338044,37.47495310729","614":"55.803837123862,37.939155756616","624":"55.978848369278,37.126014973511","625":"55.451520837238,37.399692871887","626":"55.560917640734,37.86","628":"55.426106680714,37.746502171966","629":"55.555302804905,37.252256526611","630":"55.670798028676,37.040216311768","589":"55.844666162906,37.263574187111","591":"55.63910827427,38.024974626984","604":"56.051793602963,37.576890153442","615":"56.068122279334,37.398938481521","165":"55.311278,37.75907","510":"55.943814259187,37.649451322754","575":"55.658533109618,38.08453350531","580":"55.613347149542,38.038855214294","581":"55.694205662598,37.975150362427","605":"56.187780216661,36.972638637451","597":"55.562859479058,37.86147164563","600":"55.500870792574,37.823732049348","602":"55.533754407776,37.455706736168","566":"56.051793602884,37.57586018518","588":"55.64593963642,38.012000508598","631":"56.208231695955,37.921857954188","632":"56.134533755477,37.03624810318","634":"56.304047101685,37.42435907135","616":"55.760861215822,38.09245044246","617":"55.911463162,38.260958383606","279":"55.788211203145,38.253945418266","203":"55.788156773453,38.131944042328","1105":"","1092":"55.380225,39.016936","223":"55.583283790479,37.844133846558","144":"55.378116169254,37.773668860602","196":"55.360060536741,38.112900470856","219":"55.342656207324,38.228733944427","238":"55.256000518799,39.986499786377","159":"55.946145040046,37.645607269836","153":"56.340269403917,37.538236601852","765":"55.986644842374,37.576946808995","1083":"55.944993,37.537779","1082":"55.934391,37.600137","599":"56.035154502303,37.427221228836","761":"55.975331948463,37.610881619331","134":"55.965916890881,37.588517235307","227":"55.894216138287,37.471674518433","1066":"55.43238,37.141772","271":"55.571810938969,37.352570354384","205":"55.319706060066,37.152701060791","1063":"56.164715,37.009493","1062":"55.959634,37.249247","685":"55.93260862453,37.286938349275","1061":"55.84823,38.032672","1060":"55.8424,38.110691","1059":"55.890935,37.986293","1058":"55.844925,38.195982","1040":"55.950231027425,37.808536097052","1049":"55.728863,37.316028","1048":"55.659001,37.417728","1047":"55.652435299576,37.427459874493","1045":"55.636770633401,37.423670808382","280":"55.475756886144,37.800451309508","136":"55.870911279347,38.152347931213","161":"55.861165547596,38.184314220871","270":"55.838928836809,38.197466704821","111":"55.928472510597,37.481258140228","147":"56.045345824396,37.059812761932","233":"56.093903996631,37.114277038952","260":"56.277502396913,36.995872386968","202":"55.656183325304,38.106318667984","215":"55.621449424834,38.091728415344","121":"56.007703819961,37.816581686508","171":"55.966240186087,37.939491220902","224":"55.973156440933,37.826723308182","254":"56.04004008431,37.906462896851","411":"55.963419983809,37.815063971981","990":"56.100409320227,37.759616554903","991":"56.014055860158,37.912517161377","992":"56.06519520773,37.851503756592","204":"55.34213710896,37.453653086183","267":"55.408097413882,37.164293647633","198":"55.730149757669,38.925606766968","114":"55.735834628979,37.350037303614","133":"55.589081834619,36.932874587454","95":"55.741944,37.277735","119":"55.696805499317,37.06490443072","182":"55.616179660573,37.075996369697","225":"55.603518925783,36.947400529144","230":"55.741232381988,37.080385658752","108":"55.71561493844,38.201919050926","194":"55.911329553458,38.260841581884","281":"55.88355342265,38.246716261902","576":"55.715700020824,38.201876135582","247":"55.600668128218,37.175237510563","213":"55.529489031481,37.019639931213","257":"55.448480443499,36.616322672183","272":"56.040380559876,37.610665140198","163":"55.909929686704,37.772718771164","200":"56.064822539067,37.556717808664","201":"55.960871166914,37.750214540936","209":"55.994044186502,37.606237161493","258":"56.134351443187,37.597852560461","764":"56.042142249654,37.611928239473","762":"56.042513134645,37.604365271164","763":"56.040706144897,37.610876847916","269":"55.582618852645,35.896993947258","118":"55.506315660739,36.213168359772","148":"55.639077932303,38.024856609787","185":"55.645957838412,38.012038059525","112":"55.834215601255,37.243920479538","188":"54.83977082189,39.363253367706","197":"55.985259660522,37.157705767212","131":"55.467710150611,37.701906152779","217":"55.46864572704,37.702464052254","246":"55.427750178626,37.744681559525","548":"55.512556329918,37.780698697894","245":"55.936719839039,37.51847976214","264":"56.487513673807,37.456539363538","603":"55.750530875298,37.928368398148","569":"55.770881460975,37.96230824107","183":"55.590545944296,37.186125697762","143":"55.576777882546,37.112693061639","570":"55.526114855831,37.429351387264","584":"55.62884492992,37.458278914141","172":"55.689424085603,37.790808060867","431":"55.541222718708,37.36157370376","226":"55.466528610579,37.363841317505","146":"55.634015084042,37.425601112989","150":"55.63643628206,37.420240892992","123":"55.616187443195,37.393570969289","157":"55.66076335785,37.349533543655","169":"55.433057,37.382816","156":"55.521325387929,37.263530570778","220":"55.744038551524,37.625440474091","191":"55.904527176993,37.563554771164","176":"55.705550131156,37.648732047989","167":"55.766678568981,37.801017593918","155":"55.715874198121,37.475102390213","154":"55.63113512622,37.505033940475","152":"55.615946121757,37.696663101852","139":"55.827190151701,37.601374599228","138":"55.680950259652,37.650027788361","137":"55.734577533695,37.490040228836","278":"53.820767365307,40.377900116189","263":"54.865198316844,37.209227178574","261":"54.88017857586,39.32391789245","256":"55.639280476482,36.32515922229","255":"56.462271899751,38.126532422383","181":"55.800844667638,37.829923789823","175":"55.71715208349,37.473665152115","598":"55.547112198247,37.504442756348","179":"55.6302406158,37.504484517197","184":"55.866446777623,37.43251544841","190":"55.638550973517,37.504180178574","199":"55.788264430337,37.671187669311","151":"55.632864349884,37.506491686508","173":"55.879160196955,37.454938347885","211":"55.826811751724,37.715002173294","244":"55.736103036105,37.458167067459","221":"55.580171328309,38.883080347885","218":"55.807094308856,37.797784305557","216":"55.619401640095,37.583209559525","1242":"55.587881,37.772383","1265":"55.902081,36.687932","1255":"55.947808,37.810615","1256":"55.910841,37.77025","989":"55.732966397722,36.843589489502","987":"55.697680699723,36.891969343933","986":"55.730550494897,37.05304137561","1262":"55.547529,37.74546","1239":"55.569086,37.633874","1237":"55.533319,37.821783","1981":"55.924803858585,37.444153429938","1983":"55.592076826446,37.491584625047","1987":"","2653":"55.901059740108,37.555852201798","2654":"55.924641201968,37.664331014572","126":"55.502536608031,38.138078476196","127":"55.918190095695,37.852963380859","2655":"55.3277466776,38.89521754381","2656":"55.947471406131,37.880790390213","2657":"55.727117451922,37.672539788361","2658":"55.810594152326,37.681323771164","2659":"55.317270422927,37.150375158118","2660":"55.096740784247,37.430590798175","2662":"55.603753481971,36.593168415283","2663":"55.697680699723,36.891969343933","2664":"55.963009860899,37.815526104867","2665":"55.956332538811,37.85771388481","2666":"55.672325,37.036783","2667":"55.720496,37.299771","2668":"55.675416,37.24208","2669":"55.926957,37.273713","2670":"56.063124,37.046168","2671":"55.580212,37.272003","2672":"55.956897,37.517163","2673":"56.045438,37.537479","2674":"56.283609,37.475609","2675":"56.208305,37.592159","2676":"55.938091,39.141943","2677":"55.592051,37.811056","2678":"55.494532,37.83281","2679":"55.545958,37.682914","2680":"55.924261,37.516366","2681":"55.91962,37.673414","2682":"55.890654,36.795751","2683":"55.958592,36.514039","3826":"55.718885352818,37.862171636246","3969":"55.625824658273,38.085326666565","4052":"55.904126692408,37.563519630619","4005":"55.955603962106,37.286620972029","4004":"55.498809401287,37.775426775085","4006":"55.4235933577,37.572880389977","4007":"55.729719639651,37.441913111084","4248":"55.674689301962,38.187477800647","4923":"55.871442116673,38.149558433838","5128":"55.912667084385,37.924646601852"}';
        objects = JSON.parse(pointsJSON);
        var points = [];
        for (key in objects) {
            points.push({
                coords: objects[key].split(','),
                obj_id: key
            });
        }
        function getPointOptions(index) {
            return {
                iconColor: '#5baa00',
                objectId: points[index]['obj_id'],
            };
        };
        var geoObjects = [];
        var clusterer;
	    var myMap;
	    var mapInitParams = {
		    center: [55.755814, 37.617635],
            zoom: 8
	    };

        var Map = (function() {

            ymaps.ready(init);

            function init() {
                myMap = new ymaps.Map("map", mapInitParams, {
                    balloonMaxWidth: 200,
                    searchControlProvider: 'yandex#search'
                });
                clusterer = new ymaps.Clusterer({
					preset: 'islands#invertedGreenClusterIcons',
					groupByCoordinates: false,
					hasBalloon: false,
					maxZoom: 15,
					clusterDisableClickZoom: false,
					clusterHideIconOnBalloonOpen: false,
					geoObjectHideIconOnBalloonOpen: false
				});
                for (var i = 0, len = points.length; i < len; i++) {
                    geoObjects[i] = new ymaps.Placemark(points[i]['coords'], false, getPointOptions(i));
                }

				processPoints();
                addPolygon()
            }


            function convert(coords) {
                var projection = myMap.options.get('projection');

                return coords.map(function(el) {
                    var c = projection.fromGlobalPixels(myMap.converter.pageToGlobal([el.x, el.y]), myMap.getZoom());
                    return c;
                });
            }

            function addPolygon(coord) {
                var myGeoObject = new ymaps.GeoObject({
                    geometry: {
                        type: "Polygon",
                        coordinates: [coord],
                    },
                }, {
                    fillColor: '#00FF00',
                    strokeColor: '#0000FF',
                    opacity: 0.5,
                    strokeWidth: 3
                });

                myMap.geoObjects.add(myGeoObject);

                return myGeoObject;
            }

            return {
                addPolygon: addPolygon,
                convert: convert
            };
        })();

        //----------------------

        var canv = document.getElementById('canv'),
        ctx = canv.getContext('2d'),

        line = [];

        var map = document.getElementById('map');
        canv.width = map.offsetWidth;
        canv.height = map.offsetWidth;


        var startX = 0,
        startY = 0;

        function mouseDown(e) {
            ctx.clearRect(0, 0, canv.width, canv.height);

            startX = e.pageX - e.target.offsetLeft;
            startY = e.pageY - e.target.offsetTop;

            canv.addEventListener('mouseup', mouseUp);
            canv.addEventListener('mousemove', mouseMove);


            line = [];
            line.push({
                x: startX,
                y: startY
            });
        }


        function mouseMove(e) {
            var x = e.pageX - e.target.offsetLeft,
            y = e.pageY - e.target.offsetTop;

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(x, y);
            ctx.stroke();

            startX = x;
            startY = y;
            line.push({
                x: x,
                y: y
            });
        }

        function mouseUp() {
            canv.removeEventListener('mouseup', mouseUp);
            canv.removeEventListener('mousemove', mouseMove);

            aproximate();
        }

        function aproximate() {
            ctx.clearRect(0, 0, canv.width, canv.height);
            var res = simplify(line, 5);
            res = Map.convert(res);
            contour = Map.addPolygon(res);
        }

        canv.addEventListener('mousedown', mouseDown);

		function processPoints() {
			clusterer.options.set({
				gridSize: 80,
			});

			clusterer.removeAll();
			clusterer.add(geoObjects);
			myMap.geoObjects.add(clusterer);

			myMap.setCenter(mapInitParams.center, mapInitParams.zoom, {
			    checkZoomRange: true
			});
		}

    </script>
</html>
